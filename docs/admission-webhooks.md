# Admission Webhooks

## Background

OLM is capable of managing the lifecycle of [validating](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook) and [mutating](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook) admission webhooks that are shipped alongside your operator.

You may be unfamiliar with webhooks. At a high level, after a request has been authenticated and authorized, admission webhooks intercept requests against the Kubernetes API and have an opportunity to validate or update the object before it is saved in the object store. Please refer to the following table that highlights what each webhook is capable of:

|                    | Validating Webhook | Mutating Webhook |
|--------------------|--------------------|------------------|
| Validating Objects |          x         |         x        |
| Mutating Objects   |                    |         x        |

If you are interested in learning more about admission webhooks, please review the [official kubernetes documentation](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-are-they).

## Defining your Webhook in the ClusterServiceVersion

### Creating a Webhook

It is outside the scope of this document to define the process of creating an admission webhook, however there are a few constraints that you should be aware of before developing your webhook if you plan to have it managed by OLM:

#### Certificate Authority Constraints

OLM is currently configured to provide each deployment with a single Certificate Authority (CA). The logic that generates and mounts the CA into the deployment was originally used by the [API Service](https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server/) lifecycle logic. As a result:

- The tls Cert file will be mounted to the deployment at `/apiserver.local.config/certificates/apiserver.crt`
- The tls Key file will be mounted to the deployment at `/apiserver.local.config/certificates/apiserver.key`

#### Webhook Rules Constraints

Additionally, in an attempt to prevent operator from configuring the cluster into an unrecoverable state, OLM does not allow the Rules defined in the WebhookDescription to:

- Intercept requests that target all groups
- Intercept requests that target the `operators.coreos.com` group
- Intercept requests that target the `ValidatingWebhookConfigurations` or `MutatingWebhookConfigurations` resources

### Defining a Webhook in a CSV

OLM's ClusterServiceVersion resource was recently updated to include a [WebhookDefinition object](https://github.com/operator-framework/api/blob/master/pkg/operators/v1alpha1/clusterserviceversion_types.go#L164-L180) which can be used to define validating and mutating admission webhooks that will be shipped with the operator. For your convenience, an example of a Validating WebhookDefinition can be seen below:

```yaml
apiVersion: operators.coreos.com/v1alpha1
kind: ClusterServiceVersion
metadata:
  annotations:
    description: |-
      An example CSV that contains a webhook
  name: example-webhook.v1.0.0
  namespace: placeholder
spec:
  webhookdefinitions:
  - name: example.webhpok.com
    type: ValidatingAdmissionWebhook
    deploymentName: "example-webhook-deployment"
    containerPort: 443
    sideEffects: "None"
    failurePolicy: "Ignore"
    admissionReviewVersions:
    - "v1"
    - "v1beta1"
    rules:
    - operations:
      - "CREATE"
      apiGroups:
      - ""
      apiVersions:
      - "v1"
      resources:
      - "configmaps"
    selector:
      foo: bar
    webhookPath: "/validate"
...
...
...
```

As you can see, the WebhookDescription object contains a union of the fields defined in the AdmissionWebhook and ValidatingWebhook Kubernetes objects with the exception of the NamespaceSelector, which is generated by OLM to match namespaces scoped by the [OperatorGroup](./operator-scoping.md) that the operator is deployed in.

OLM requires that you define the following:

- The `Type` field must be set to `ValidatingWebhook` or `MutatingWebhook` or the CSV will fail to install as expected.
- The CSV must contain a Deployment whose name is equivalent to the value supplied in the `DeploymentName` field of the WebhookDescription.
